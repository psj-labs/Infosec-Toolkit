# nmap

- 우선 대상 사이트의 IP 주소를 확인하기 위해 nslookup 명령어로 사이트 주소를 확인합니다.  
- 필자는 scanme.nmap.org 사이트의 포트 스캔을 진행할 것이므로 사용한 명령어는 다음과 같습니다.
```text
nslookup scanme.nmap.org
```
- 그럼 다음과 같이 IP 주소가 `45.33.32.156`으로 출력된 것을 확인할 수 있습니다.  
- 사이트 주소 대신 이 IP 주소로 접속해도 동일한 페이지가 출력됩니다.

![01](/nmap/imgs/01.png)

---

## 기본 포트 스캔

- nmap의 기본적인 스캔은 단일 타겟 스캔이며 문법은 다음과 같습니다.
```text
nmap [IP]
```
- 필자는 앞서 확인한 IP 주소에 대해 포트 스캔을 수행하였고 사용한 명령어는 다음과 같습니다.
```text
nmap 45.33.32.156
```
- 잠시 기다리면 열려 있는 포트들이 출력되는 것을 확인할 수 있습니다.

![02](/nmap/imgs/02.png)

---

## 포트 스캔 동작 원리 (Wireshark 분석)

- 현재 필자의 IP는 `192.168.0.121`, 목적지 IP는 `45.33.32.156(공격대상)`입니다.
- `TCP`패킷만 필터링해 관찰해보겠습니다.

![03](/nmap/imgs/03.png)

- 패킷을 관찰해보면 `필자의 IP`에서 `목적지 IP`로 `TCP 패킷`을 전송하며 포트 번호만 변경하면서 반복적으로 요청하는 것을 확인할 수 있습니다.

![04](/nmap/imgs/04.png)

- 웹 서비스의 경우 일반적으로 `HTTP(80)`, `HTTPS(443)` 포트부터 확인하며 이후 111, 110, 113 등 잘 알려진 포트 번호들을 순차적으로 시도합니다.

- 포트 번호는 총 `65535개`이지만 nmap은 자주 사용되는 포트 위주로 먼저 스캔하기 때문에 기본 스캔은 오래 걸리지 않습니다.

---

## 전체 포트 스캔

- 모든 포트를 빠짐없이 확인하고 싶을 경우 다음과 같이 실행합니다.
```text
nmap -p- [IP]
```
- 시간은 오래 걸리지만 빈틈없는 포트 탐색이 가능합니다.

---

## 포트 범위 지정 스캔

- 일반적으로 Well-Known Port(1~1024)는 필수적으로 확인합니다.
```text
nmap -p 1-1000 [IP]
```
---

## 특정 포트 지정 스캔
```text
nmap -p 22,80,443 [IP]
```
- 지정한 포트만 선택적으로 스캔합니다.

---

## 다중 타겟 스캔
```text
nmap [IP1] [IP2]
```
---

## IP 범위 스캔
```text
nmap x.x.x.1-20
```
---

## 주요 분석 옵션

| 옵션 | 이름 | 설명 | 특징 |
| --- | --- | --- | --- |
| -F | Fast Scan | 자주 사용되는 포트 100개만 빠르게 스캔 | 초기 정찰용 |
| -p | Port 지정 | 특정 포트만 지정하여 스캔 | 정밀 스캔 |
| -sV | Service Version | 서비스 이름 및 버전 확인 | 취약점 분석 필수 |
| -O | OS Detection | 운영체제 추측 | sudo 필요 |
| -A | Aggressive | OS, 버전, 스크립트, 경로 추적 | 정보 풍부, 탐지 위험 |

---

## 스캔 방식 옵션

| 옵션 | 이름 | 설명 | 특징 |
| --- | --- | --- | --- |
| -sS | TCP SYN Scan | 반개방(Half-open) 스캔 | sudo 필요, 은밀 |
| -sT | TCP Connect Scan | 완전한 3-Way Handshake | 기본값 |
| -sU | UDP Scan | UDP 포트 스캔 | 느림, 오탐 가능 |
| -Pn | No Ping | Ping 응답 없어도 스캔 | ICMP 차단 우회 |
| --host-timeout | Host Timeout | 시간 초과 시 스캔 중단 | 대규모 스캔 |
| --max-retries | Max Retries | 재전송 횟수 제한 | 속도 개선 |

---

## 타이밍 옵션

| 옵션 | 이름 | 설명 | 특징 |
| --- | --- | --- | --- |
| -T0 ~ -T1 | Paranoid / Sneaky | 매우 느림 | 탐지 회피 |
| -T3 | Normal | 기본값 | 안정적 |
| -T4 | Aggressive | 빠름 | 실무 최다 |
| -T5 | Insane | 매우 빠름 | 오탐 위험 |

---

## 권장 명령어 예시
```text
sudo nmap -sS -sV -p 1-1000 -T4 -Pn [IP]
```
-> `스텔스 스캔`으로 서비스 버전을 확인하면서 1~1000번 포트만 빠르게 상대가 응답하지 않아도 강제로 스캔

---

## 주의사항

- `-sS`, `-O` 같은 고급 옵션은 반드시 `sudo` 필요
- 허가 없는 사이트 스캔은 불법
